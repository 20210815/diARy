<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>roadmap</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

  <!-- kakao map api -->
  <script
    type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=08e5a0f9ad6656a4e9d4a0afc5f90c36&libraries=services,clusterer,drawing"
  ></script>

  <!-- style sheet 적용 -->
  <link rel="stylesheet" href="css/nearPlace.css">

  <style>
    body {
      margin : 0;
    }
        
    #roadview {
      width: 100vw; 
      height: 65vh;
    }
  </style>
</head>
<body>
  <div id="roadview"></div>

  <div id="near_place">
    <h6>근처 장소(<span id="place_cnt">n</span>)</h6>
    <p class="filter">카테고리 | <span id="filter_option">관광명소</span></p>
    <!-- carousel slider -->
    <div id="carouselExampleIndicators" class="carousel slide">
      <div class="carousel-inner">
        <!-- <div class="carousel-item active">
          <div class="row row-cols-3">
            <div class ="col">
              <img class="place_img" src="image/sample.png">
              <p class="place_name">장소이름</p>
            </div>
          </div>
        </div> -->
      </div>

      <div class="carousel-indicators">
        <!-- <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button> -->
      </div>
    </div>
  </div>

  <script>
    var temp = Android.getPlaceInfo(),
        x = temp.split('/')[2],
        y = temp.split('/')[3];

    var position = new kakao.maps.LatLng(Number(y), Number(x));

    console.log("temp, x, y" + temp, x, y);

    //로드맵 표시
    var roadviewContainer = document.getElementById('roadview');
    var roadview = new kakao.maps.Roadview(roadviewContainer);
    var roadviewClient = new kakao.maps.RoadviewClient();

    //특정 위치의 좌표와 가까운 로드뷰의 panoId를 추출하여 로드뷰를 띄운다.
    roadviewClient.getNearestPanoId(position, 50, function(panoId) {
      roadview.setPanoId(panoId, position);
    })

    /////////////////////////////////////////////////////////////////
    ///                 근처 장소 검색(카테고리)                    ///
    /////////////////////////////////////////////////////////////////
    
    var places = [],
        options = {
            location: position,
            radius: 10000, //10km
            sort: kakao.maps.services.SortBy.DISTANCE,
        };

    var ps = new kakao.maps.services.Places();

    ps.categorySearch('AT4', placesSearchCB, options); //관광명소(임시 카테고리 지정)

    //키워드 검색 완료 시 호출되는 콜백 함수
    function placesSearchCB(result, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {

        console.log("Search successed");
        console.log("totalCount: " + pagination.totalCount);
        
        for(var i = 0; i < result.length; i++) {
          var place = result[i],
              temp = [place.place_name, place.road_address_name, place.x, place.y];

          //places[i] = temp;
          places.push(temp);
        }
        console.log("places: " + places);
        console.log('places[0]: ' + places[0]);

        displaySlider(places);

      } else {
        console.log("Search failed");
      }
    }

    /////////////////////////////////////////////////////////////////
    ///                   carousel slider 작성                    ///
    /////////////////////////////////////////////////////////////////

    //html 추가
    function displaySlider(places) {

      var i = 0, j = 6, btn = 0;
      var items = document.querySelector('.carousel-inner');
      var indicators = document.querySelector('.carousel-indicators');

      while(true) {
        var item = document.createElement('div');
        item.className = 'carousel-item';

        var row = document.createElement('div');
        row.className = 'row row-cols-3';

        var button = document.createElement('button');
        button.type = 'button'
        button.setAttribute('data-bs-target', '#carouselExampleIndicators');
        button.setAttribute('data-bs-slide-to', btn);
        button.setAttribute('aria-label', 'Slide ' + (btn+1));

        items.appendChild(item);
        item.appendChild(row);

        indicators.appendChild(button);

        btn += 1;

        console.log("[" + i + "~" + j + "] item 생성");

        for (i; i < j; i++) {
          var col = document.createElement('div');
          col.className = 'col';

          var img = document.createElement('img');
          img.className = 'place_img';
          img.src = 'image/sample.png';

          var p = document.createElement('p');
          p.className = 'place_name';
          p.textContent = places[i][0];

          row.appendChild(col);
          col.appendChild(img);
          col.appendChild(p);
        }

        if(j === places.length) { break; }
        
        j += 6;

        if(j > places.length) { j = places.length; }
      }

      var active_item = document.querySelectorAll('.carousel-item')[0];
      active_item.className += ' active';

      var active_indicator = document.querySelectorAll('.carousel-indicators button')[0];
      active_indicator.className = 'active';
      active_indicator.setAttribute('aria-current', 'true');
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
  </body>
</html>